# Экзамен #
## Автор: Окуньков Николай Степанович ##

*db<>fiddle [here](https://dbfiddle.uk/?rdbms=postgres_12&fiddle=33d81aac9c46ec56b6caf4254b364948)*

### 1.	Дана схема базы данных в виде следующих отношений.  С помощью операторов SQL создать логическую структуру соответствующих таблиц для хранения в СУБД, используя известные средства поддержания целостности (NOT NULL, UNIQUE, и т.д.). Обосновать выбор типов данных и используемые средства поддержания целостности. При выборе подходящих типов данных использовать информацию о конкретных значениях полей БД (см. прил.1)
```SQL

CREATE TABLE "ВОДИТЕЛЬ"
(
    "ИДЕНТИФИКАТОР" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    -- Идентификатор integer, не должен быть NULL. Если не задан,
    -- задается автоматоматически
    "ФАМИЛИЯ" character varying (50),
    -- character varying на 50 символов вполне хватит
    "АВТОПРЕДПРИЯТИЕ" character varying (50),
    -- character varying на 50 символов вполне хватит
    "ЛЬГОТА" smallint CHECK ("ЛЬГОТА">=0 AND "ЛЬГОТА"<=100),
    -- smallint занимает минимум памяти. CHECK позволяет избежать
    -- ошибок и хранить в данном поле только значения от 0% до 100%
    PRIMARY KEY ("ИДЕНТИФИКАТОР")
);

CREATE TABLE "ЦЕНТР ОБСЛУЖИВАНИЯ"
(
    "ИДЕНТИФИКАТОР" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    -- Идентификатор integer, не должен быть NULL. Если не задан,
    -- задается автоматоматически
    "НАЗВАНИЕ" character varying (50),
    -- character varying на 50 символов вполне хватит
    "ВЛАДЕЛЕЦ" character varying (50),
    -- character varying на 50 символов вполне хватит
    "КОМИССИОННЫЕ" smallint CHECK ("КОМИССИОННЫЕ">=0 AND "КОМИССИОННЫЕ"<=100),
    -- smallint занимает минимум памяти. CHECK позволяет избежать
    -- ошибок и хранить в данном поле только значения от 0% до 100%
    PRIMARY KEY ("ИДЕНТИФИКАТОР")
);

CREATE TABLE "ПРЕЙСКУРАНТ"
(
    "ИДЕНТИФИКАТОР" integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    -- Идентификатор integer, не должен быть NULL. Если не задан,
    -- задается автоматоматически
    "ТОВАР" text,
    -- возможно, существуют какие-то длинные названия товаров. На всякий
    -- случай сделаем это поле text. В предоставленных данных таких заданий нет,
    -- поэтому, в принципе, можно заменить текст на varchar (character varying)
    "ЦЕНА" int,
    -- т.к. она в рублях, а рубль из-за дяди Вовы обесценивается с огромной
    -- скоростью, smallint здесь может не хватить
    "У КОГО ЗАКУПАЕТСЯ" character varying (50),
    -- character varying на 50 символов вполне хватит
    "МАКС. КОЛ-ВО" smallint,
    -- вряд-ли будет более 32767, однако если в базе будут крупные закупки,
    -- лучше использовать integer
    PRIMARY KEY ("ИДЕНТИФИКАТОР")
);

CREATE TABLE "ЗАКАЗ"
(
    "НОМЕР ВЕДОМОСТИ" integer NOT NULL,
    -- не должен быть NULL
    "ДАТА" varchar (10),
    -- т.к. тут хранятся названия месяцев, не вижу смысла делать больше 10
    -- можно добавить огромный чек на кейсах, чтобы сюда нельзя было записать
    -- ничего кроме названия месяцев. Но не хочется вставлять кучу строчек
    -- с условиями. Можно было также преобразовывать эти значения и хранить их 
    -- в date, но я подумал, что раз они даны в таком виде, лучше в нем их и
    -- оставить.
    "ВОДИТЕЛЬ" integer,
    "ЦЕНТР ОБСЛ." integer,
    "ТОВАР ПО ПРЕЙСКУРАНТУ" integer,
    -- Эти три поля выше, по сути, связаны с теми, что были в предыдущих таблицах,
    -- поэтому и типы мы им оставим такие же
    "КОЛ-ВО" smallint,
    -- вряд-ли будет более 32767, однако если в базе будут крупные закупки,
    -- лучше использовать integer
    "ИТОГО" int,
    -- можно было использовать money, но конкретно для заданий из методички
    -- и для предоставленных данных это оказалось не слишком удобным.
    PRIMARY KEY ("НОМЕР ВЕДОМОСТИ")
);
```
<pre>

 
 
 ✓
 
 ✓
 
 ✓
 
 ✓
 </pre>
 
 ```SQL

INSERT INTO "ВОДИТЕЛЬ" VALUES
(001, 'Горбунов', 'АТП1', 5),
(002,'Попов','МП "ФорТУНА"',0),
(003,'Денисов','АО "Автотранс"',10),
(004,'Сергеев','АО "Автотранс"',10),
(005,'Левкин','АТП1',5);

INSERT INTO "ЦЕНТР ОБСЛУЖИВАНИЯ" VALUES
('001', 'Окружная дорога1', 'АТП1', '3'),
('002', 'Окружная дорога2', 'АТП1', '3'),
('003', '123КМ', 'АО "Автотранс"', '2'),
('004', 'АЗС12', 'АО "ФорТУНА"', '4'),
('005', 'АЗС7', 'АТП1', '3'),
('006', 'У поворота', 'АО "ФорТУНА"', '4');

INSERT INTO "ПРЕЙСКУРАНТ" VALUES
('001', 'Бензин АИ-72', '9000', 'АТП1', '10000'),
('002', 'Бензин АИ-96', '10000', 'АТП1', '12000'),
('003', 'Масло моторное МТ23-12', '7000', 'АО "ФорТУНА"', '7000'),
('004', 'Масло моторное УММ-23Т', '18500', 'АО "Автотранс"', '5300'),
('005', 'Свеча зажигания', '22000', 'АО "Автотранс"', '200'),
('006', 'Прокладка', '6000', 'АТП1', '500'),
('007', 'Жидкость смывная', '12000', 'АО "ФорТУНА"', '100');

INSERT INTO "ЗАКАЗ" VALUES
('12201', 'Январь', '002', '004', '007', '4', '48000'),
('12202', 'Январь', '003', '005', '007', '4', '48000'),
('12203', 'Январь', '003', '005', '007', '6', '72000'),
('12204', 'Февраль', '003', '003', '004', '2', '37000'),
('12205', 'Февраль', '004', '002', '001', '40', '360000'),
('12206', 'Февраль', '004', '001', '001', '40', '360000'),
('12207', 'Март', '003', '001', '001', '20', '180000'),
('12208', 'Апрель', '002', '004', '003', '10', '70000'),
('12209', 'Апрель', '003', '003', '006', '4', '24000'),
('12210', 'Май', '001', '002', '006', '2', '12000'),
('12211', 'Май', '003', '006', '003', '2', '14000'),
('12212', 'Июнь', '005', '004', '007', '10', '120000'),
('12213', 'Июль', '003', '004', '004', '10', '185000'),
('12214', 'Июль', '005', '004', '002', '6', '60000'),
('12215', 'Август', '002', '006', '005', '4', '88000'),
('12216', 'Сентябрь', '001', '004', '005', '6', '132000'),
('12217', 'Сентябрь', '003', '001', '007', '40', '360000');
```
<pre>
 
5 rows affected
 
6 rows affected
 
7 rows affected
 
17 rows affected
</pre>
### 2.	Вывести названия центров обслуживания, где осуществляли покупку товаров стоимостью от 8000 до 10000руб. автоводители из организации владельца;
```SQL
SELECT DISTINCT НАЗВАНИЕ FROM "ЦЕНТР ОБСЛУЖИВАНИЯ" WHERE ИДЕНТИФИКАТОР IN
(SELECT "ЦЕНТР ОБСЛ." FROM ЗАКАЗ WHERE ВОДИТЕЛЬ IN
(SELECT ИДЕНТИФИКАТОР FROM ВОДИТЕЛЬ WHERE АВТОПРЕДПРИЯТИЕ IN
(SELECT ВЛАДЕЛЕЦ FROM "ЦЕНТР ОБСЛУЖИВАНИЯ")) AND ИТОГО BETWEEN 8000 AND 10000
);
 ```
 
 | НАЗВАНИЕ |
 | :--------------- |
 
### 3.	Создать запрос для модификации всех значений столбца с итоговой платой, чтобы он содержал истинную сумму, оплачиваемую работником ( с учетом льгот). Вывести новые значения.
```SQL
UPDATE ЗАКАЗ SET ИТОГО = ИТОГО-ИТОГО/100*ВОДИТЕЛЬ.ЛЬГОТА FROM ВОДИТЕЛЬ
WHERE ВОДИТЕЛЬ.ИДЕНТИФИКАТОР = ЗАКАЗ.ВОДИТЕЛЬ;

SELECT * FROM ЗАКАЗ -- проверяем
 ```
 <pre>
17 rows affected
 </pre>
 НОМЕР ВЕДОМОСТИ | ДАТА         | ВОДИТЕЛЬ | ЦЕНТР ОБСЛ. | ТОВАР ПО ПРЕЙСКУРАНТУ | КОЛ-ВО | ИТОГО
 ----------------------------: | :--------------- | ---------------: | -------------------: | ---------------------------------------: | ----------: | ---------:
12201 | Январь     |                2 |                    4 |                                        7 |           4 |      48000
12202 | Январь     |                3 |                    5 |                                        7 |           4 |      43200
12203 | Январь     |                3 |                    5 |                                        7 |           6 |      64800
12204 | Февраль   |                3 |                    3 |                                        4 |           2 |      33300
12205 | Февраль   |                4 |                    2 |                                        1 |          40 |     324000
12206 | Февраль   |                4 |                    1 |                                        1 |          40 |     324000
12207 | Март         |                3 |                    1 |                                        1 |          20 |     162000
12208 | Апрель     |                2 |                    4 |                                        3 |          10 |      70000
12209 | Апрель     |                3 |                    3 |                                        6 |           4 |      21600
12210 | Май           |                1 |                    2 |                                        6 |           2 |      11400
12211 | Май           |                3 |                    6 |                                        3 |           2 |      12600
12212 | Июнь         |                5 |                    4 |                                        7 |          10 |     114000
12213 | Июль         |                3 |                    4 |                                        4 |          10 |     166500
12214 | Июль         |                5 |                    4 |                                        2 |           6 |      57000
12215 | Август     |                2 |                    6 |                                        5 |           4 |      88000
12216 | Сентябрь |                1 |                    4 |                                        5 |           6 |     125400
12217 | Сентябрь |                3 |                    1 |                                        7 |          40 |     324000
 
### 4.	Расширить таблицу с данными о заказах столбцом, содержащим величину комиссионных для данного заказа. Создать запрос для ввода конкретных значений во все строки таблицы.
```SQL
ALTER TABLE ЗАКАЗ ADD COLUMN КОМИССИОННЫЕ smallint;

UPDATE ЗАКАЗ SET КОМИССИОННЫЕ = "ЦЕНТР ОБСЛУЖИВАНИЯ".КОМИССИОННЫЕ FROM "ЦЕНТР ОБСЛУЖИВАНИЯ"
WHERE "ЦЕНТР ОБСЛУЖИВАНИЯ".ИДЕНТИФИКАТОР = ЗАКАЗ."ЦЕНТР ОБСЛ.";

SELECT * FROM ЗАКАЗ -- проверяем
 ```
 <pre>
 ✓
 
17 rows affected
 </pre>
 НОМЕР ВЕДОМОСТИ | ДАТА         | ВОДИТЕЛЬ | ЦЕНТР ОБСЛ. | ТОВАР ПО ПРЕЙСКУРАНТУ | КОЛ-ВО | ИТОГО | КОМИССИОННЫЕ
 ----------------------------: | :--------------- | ---------------: | -------------------: | ---------------------------------------: | ----------: | ---------: | -----------------------:
12201 | Январь     |                2 |                    4 |                                        7 |           4 |      48000 |                        4
12202 | Январь     |                3 |                    5 |                                        7 |           4 |      43200 |                        3
12203 | Январь     |                3 |                    5 |                                        7 |           6 |      64800 |                        3
12204 | Февраль   |                3 |                    3 |                                        4 |           2 |      33300 |                        2
12205 | Февраль   |                4 |                    2 |                                        1 |          40 |     324000 |                        3
12206 | Февраль   |                4 |                    1 |                                        1 |          40 |     324000 |                        3
12207 | Март         |                3 |                    1 |                                        1 |          20 |     162000 |                        3
12208 | Апрель     |                2 |                    4 |                                        3 |          10 |      70000 |                        4
12209 | Апрель     |                3 |                    3 |                                        6 |           4 |      21600 |                        2
12210 | Май           |                1 |                    2 |                                        6 |           2 |      11400 |                        3
12211 | Май           |                3 |                    6 |                                        3 |           2 |      12600 |                        4
12212 | Июнь         |                5 |                    4 |                                        7 |          10 |     114000 |                        4
12213 | Июль         |                3 |                    4 |                                        4 |          10 |     166500 |                        4
12214 | Июль         |                5 |                    4 |                                        2 |           6 |      57000 |                        4
12215 | Август     |                2 |                    6 |                                        5 |           4 |      88000 |                        4
12216 | Сентябрь |                1 |                    4 |                                        5 |           6 |     125400 |                        4
12217 | Сентябрь |                3 |                    1 |                                        7 |          40 |     324000 |                        3

### 5.	Используя операцию IN (NOT IN)  реализовать следующие запросы:
a)	найти водителей, не покупавших товаров в центрах обслуживания с комиссионными более 2%;
```SQL
SELECT ВОДИТЕЛЬ.ФАМИЛИЯ FROM ВОДИТЕЛЬ WHERE ВОДИТЕЛЬ.ИДЕНТИФИКАТОР NOT IN
(SELECT ВОДИТЕЛЬ.ИДЕНТИФИКАТОР FROM ЗАКАЗ
JOIN "ЦЕНТР ОБСЛУЖИВАНИЯ" ON "ЦЕНТР ОБСЛУЖИВАНИЯ".ИДЕНТИФИКАТОР = ЗАКАЗ."ЦЕНТР ОБСЛ."
JOIN ВОДИТЕЛЬ ON ВОДИТЕЛЬ.ИДЕНТИФИКАТОР = ЗАКАЗ.ВОДИТЕЛЬ
WHERE "ЦЕНТР ОБСЛУЖИВАНИЯ".ИДЕНТИФИКАТОР NOT IN 
(SELECT ИДЕНТИФИКАТОР FROM "ЦЕНТР ОБСЛУЖИВАНИЯ" WHERE КОМИССИОННЫЕ <=2));
 ```
 
 | ФАМИЛИЯ |
 | :------------- |
 
 
### 6.	Используя операции ALL-ANY реализовать следующие запросы:
a)	найти водителей, покупавших товары, которые в мае заказывались в наибольшем количестве;
```SQL
SELECT DISTINCT ВОДИТЕЛЬ.ФАМИЛИЯ FROM ЗАКАЗ 
JOIN ВОДИТЕЛЬ ON ВОДИТЕЛЬ.ИДЕНТИФИКАТОР = ЗАКАЗ.ВОДИТЕЛЬ
WHERE ЗАКАЗ."ТОВАР ПО ПРЕЙСКУРАНТУ" = ANY
((
SELECT "ТОВАР ПО ПРЕЙСКУРАНТУ" FROM ЗАКАЗ WHERE ДАТА = 'Май'
GROUP BY "ТОВАР ПО ПРЕЙСКУРАНТУ"
HAVING COUNT("ТОВАР ПО ПРЕЙСКУРАНТУ") >= ALL 
(SELECT COUNT("ТОВАР ПО ПРЕЙСКУРАНТУ") as cnt
FROM ЗАКАЗ WHERE ДАТА = 'Май'
GROUP BY "ТОВАР ПО ПРЕЙСКУРАНТУ")
));
 ```
 
 | ФАМИЛИЯ   |
 | :--------------- |
 | Горбунов |
 | Денисов   |
 | Попов       |
 
### 7.	Используя операцию UNION получить места работы водителей и организации, продающие товары в центры обслуживания.
```SQL
SELECT АВТОПРЕДПРИЯТИЕ FROM ВОДИТЕЛЬ UNION SELECT ВЛАДЕЛЕЦ FROM "ЦЕНТР ОБСЛУЖИВАНИЯ"
```
 
 | АВТОПРЕДПРИЯТИЕ |
 | :----------------------------- |
 | АО &quot;Автотранс&quot;      |
 | АО &quot;ФорТУНА&quot;          |
 | МП &quot;ФорТУНА&quot;          |
 | АТП1                        |
 
### 8.	Используя операцию EXISTS ( NOT EXISTS ) реализовать нижеследующие запросы. В случае, если для текущего состояния БД запрос будет выдавать пустое множество строк, требуется указать какие добавления в БД необходимо провести

a)	найти водителей, покупавших все товары, которые не продаются центром обслуживания с максимальным размером комиссионных;

```SQL
WITH searchValues AS
(
    SELECT DISTINCT "ТОВАР ПО ПРЕЙСКУРАНТУ" FROM ЗАКАЗ as za WHERE NOT EXISTS 
    (SELECT "НОМЕР ВЕДОМОСТИ"
    FROM ЗАКАЗ WHERE "ЗАКАЗ"."ТОВАР ПО ПРЕЙСКУРАНТУ" = za."ТОВАР ПО ПРЕЙСКУРАНТУ"
    AND "ЗАКАЗ"."ЦЕНТР ОБСЛ." IN (
    SELECT ИДЕНТИФИКАТОР FROM "ЦЕНТР ОБСЛУЖИВАНИЯ" WHERE КОМИССИОННЫЕ =
    (SELECT MAX(КОМИССИОННЫЕ) FROM "ЦЕНТР ОБСЛУЖИВАНИЯ")))
)
SELECT ФАМИЛИЯ FROM ЗАКАЗ 
JOIN ВОДИТЕЛЬ ON ВОДИТЕЛЬ.ИДЕНТИФИКАТОР = ЗАКАЗ.ВОДИТЕЛЬ
JOIN searchValues s ON s."ТОВАР ПО ПРЕЙСКУРАНТУ" = ЗАКАЗ."ТОВАР ПО ПРЕЙСКУРАНТУ"
WHERE s."ТОВАР ПО ПРЕЙСКУРАНТУ" = ЗАКАЗ."ТОВАР ПО ПРЕЙСКУРАНТУ"
GROUP BY ФАМИЛИЯ
HAVING COUNT(DISTINCT ЗАКАЗ."ТОВАР ПО ПРЕЙСКУРАНТУ") = (SELECT COUNT("ТОВАР ПО ПРЕЙСКУРАНТУ") FROM searchValues);
```
 
### 9.	Реализовать запросы с использованием аггрегатных функций:
 a)	какие водители приобретали в центрах обслуживания, принадлежащих чужим АТП, товары с максимальной ценой ;
```SQL
SELECT DISTINCT ФАМИЛИЯ FROM ЗАКАЗ as Z JOIN
ВОДИТЕЛЬ AS V ON V.ИДЕНТИФИКАТОР = Z.ВОДИТЕЛЬ
JOIN ПРЕЙСКУРАНТ ON ПРЕЙСКУРАНТ.ИДЕНТИФИКАТОР =  Z."ТОВАР ПО ПРЕЙСКУРАНТУ"
WHERE ЦЕНА = (
SELECT MAX (ЦЕНА) FROM ЗАКАЗ 
JOIN ПРЕЙСКУРАНТ ON ПРЕЙСКУРАНТ.ИДЕНТИФИКАТОР =  ЗАКАЗ."ТОВАР ПО ПРЕЙСКУРАНТУ"
WHERE "ЦЕНТР ОБСЛ." = Z."ЦЕНТР ОБСЛ."
) AND "ЦЕНТР ОБСЛ." NOT IN (SELECT ИДЕНТИФИКАТОР FROM "ЦЕНТР ОБСЛУЖИВАНИЯ"
WHERE ВЛАДЕЛЕЦ = V.АВТОПРЕДПРИЯТИЕ)
``` 
 
 | ФАМИЛИЯ   |
 | :--------------- |
 | Горбунов |
 | Денисов   |
 | Попов  |
 | Сергеев   |
 
### 10.	Используя средства группировки реализовать следующие запросы:
a)	вывести названия центров обслуживания вместе с сумарной стоимостью сделанных в этих центрах заказов в том случае, если суммарная стоимость более 200000;

 ```SQL
SELECT НАЗВАНИЕ, SUM(ИТОГО) FROM ЗАКАЗ
JOIN "ЦЕНТР ОБСЛУЖИВАНИЯ" ON "ЦЕНТР ОБСЛУЖИВАНИЯ".ИДЕНТИФИКАТОР = ЗАКАЗ."ЦЕНТР ОБСЛ."
GROUP BY НАЗВАНИЕ HAVING SUM(ИТОГО) > 200000
  ```
  
 НАЗВАНИЕ|    sum
 :----------------------------- | -----:
 Окружная дорога1 | 810000
 Окружная дорога2 | 335400
 АЗС12   | 580900
 
